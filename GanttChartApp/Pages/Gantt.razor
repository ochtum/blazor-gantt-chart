@page "/gantt"
@using GanttChartApp.Models
@using Microsoft.JSInterop
@using System.Collections.Generic
@using System

<h3>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h3>

<div class="gantt-header">
    <button class="btn btn-primary" @onclick="AddTask">+ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
    <button class="btn btn-secondary" @onclick="SaveJson">ä¿å­˜</button>
    <input type="file" @onchange="LoadJson" />
</div>

<div class="gantt-main">
    <div class="task-list">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>ã‚¿ã‚¹ã‚¯</th>
                    <th>æ‹…å½“è€…</th>
                    <th>é–‹å§‹æ—¥</th>
                    <th>çµ‚äº†æ—¥</th>
                    <th>é€²æ—ç‡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Tasks)
                {
                    <tr>
                        <td><input value="@task.Name" @onchange="e => UpdateTask(task, nameof(task.Name), e.Value?.ToString())" /></td>
                        <td><input value="@task.Assignee" @onchange="e => UpdateTask(task, nameof(task.Assignee), e.Value?.ToString())" /></td>
                        <td><input type="date" value="@task.StartDate.ToString("yyyy-MM-dd")" @onchange="@(e => UpdateTask(task, nameof(task.StartDate), ((ChangeEventArgs)e).Value?.ToString()))" /></td>
                        <td><input type="date" value="@task.EndDate.ToString("yyyy-MM-dd")" @onchange="@(e => UpdateTask(task, nameof(task.EndDate), ((ChangeEventArgs)e).Value?.ToString()))" /></td>
                        <td><input type="number" min="0" max="100" value="@task.Progress" @onchange="e => UpdateTask(task, nameof(task.Progress), e.Value?.ToString())" /></td>
                        <td><button class="btn btn-danger btn-sm" @onclick="() => RemoveTask(task)">ğŸ—‘</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="timeline">
        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³éƒ¨åˆ†ã¯ä»Šå¾ŒJSInteropã§å®Ÿè£…äºˆå®š -->
        <p>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆã‚¬ãƒ³ãƒˆãƒãƒ¼ï¼‰ã¯ä»Šå¾Œå®Ÿè£…ã—ã¾ã™ã€‚</p>
    </div>
</div>

@code {
    List<GanttTask> Tasks = new();
    int nextId = 1;

    void AddTask()
    {
        Tasks.Add(new GanttTask
        {
            Id = nextId++,
            Name = "æ–°ã—ã„ã‚¿ã‚¹ã‚¯",
            Assignee = "",
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(1),
            Progress = 0
        });
    }

    void RemoveTask(GanttTask task)
    {
        Tasks.Remove(task);
    }

    void UpdateTask(GanttTask task, string property, string? value)
    {
        if (property == nameof(task.Name)) task.Name = value ?? "";
        if (property == nameof(task.Assignee)) task.Assignee = value ?? "";
        if (property == nameof(task.StartDate) && DateTime.TryParse(value, out var sd)) task.StartDate = sd;
        if (property == nameof(task.EndDate) && DateTime.TryParse(value, out var ed)) task.EndDate = ed;
        if (property == nameof(task.Progress) && int.TryParse(value, out var prg)) task.Progress = prg;
    }

    async void SaveJson()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(Tasks);
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var fileName = $"GANT{DateTime.Now:yyyyMMddHHmmss}.json";
        await JS.InvokeVoidAsync("saveAsFile", fileName, Convert.ToBase64String(bytes));
    }

    async void LoadJson(ChangeEventArgs e)
    {
        if (e.Value is not null)
        {
            // å®Ÿè£…ã¯JSInteropã§ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã‚’è¡Œã†å¿…è¦ã‚ã‚Š
        }
    }

    [Inject] IJSRuntime JS { get; set; } = default!;
}
